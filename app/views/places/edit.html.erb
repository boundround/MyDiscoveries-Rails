<div class="edit-container">
  <% if user_signed_in? %>
  <h1>Edit <%= @place.display_name + ' (ID: ' + @place.id.to_s + ')' %></h1>
  <p>
    <a href="<%= place_path(@place) %>" target="blank">Preview</a>
  </p>
  <%= simple_form_for @place, html: { role: 'form'} do |f| %>
    <% if current_user.has_role?("publisher") || current_user.has_role?("editor") || current_user.admin? %>
      <div class="form-group">
        <%= f.input :display_name, input_html: { class: 'form-control' } %>
      </div>
      <div class="form-group">
        <%= f.input :country_id, label: 'Country', collection: Country.all, as: :select, label_method: :display_name, value_method: :id, required: true %>
      </div>
      <div class="form-group">
        <%= f.input :description, as: :bootsy, label: false, input_html: { class: 'form-control area-description-input' } %>
      </div>
      <div class="form-group">
        <%= f.input :tag_list, label: 'Tags (Comma Separated Values)', input_html: { class: 'form-control'} %>
      </div>
      <div class="form-group">
        <%= f.input :location_list, label: 'Location Tags (Comma Separated Values)', input_html: { class: 'form-control'} %>
      </div>
      <div class="form-group">
        <%= f.input :activity_list, label: 'Activity Tags (Comma Separated Values)', input_html: { class: 'form-control'} %>
      </div>
      <div class="form-group">
        <%= f.input :website, input_html: { class: 'form-control' } %>
      </div>
      <div class="form-group">
        <%= f.input :booking_url, input_html: { class: 'form-control' } %>
      </div>
    <% end %>
    <% if current_user.has_role?("publisher") || current_user.try(:admin) %>
      <div class="form-group published-radio">
        <%= f.input :subscription_level, as: :radio_buttons, collection: ["basic", "standard", "Premium"] %>
      </div>
      <div class="form-group published-radio">
        <%= f.input :status, as: :radio_buttons, collection: ["draft", "edited", "live", "removed"] %>
      </div>
      <div>
        <%= f.input :customer_review, inline_label: "-- Customer Review", label: false %>
      </div>
      <div>
        <%= f.input :customer_approved, inline_label: "-- Customer Approved", label: false %> <%= @place.approved_at.strftime('%F at %T') if @place.approved_at %>
      </div>
      <div class="form-group">
        <%= f.input :published_at, as: :date, order: [:day, :month, :year], include_blank: true, label: "Publish At" %>
      </div>
      <div class="form-group">
        <%= f.input :unpublished_at, as: :date, order: [:day, :month, :year], include_blank: true, label: "Remove At" %>
      </div>
    <% elsif current_user.has_role?("editor") %>
      <div class="form-group published-radio">
        <%= f.input :subscription_level, as: :radio_buttons, collection: ["basic", "standard", "Premium"] %>
      </div>
      <% if @place.status == "draft" || @place.status == "edited" %>
        <div class="form-group published-radio">
          <%= f.input :status, as: :radio_buttons, collection: ["draft", "edited"] %>
        </div>
      <% else %>
      <div class="form-group published-radio">
        <%= f.input :status, as: :radio_buttons, collection: [@place.status] %>
      </div>
      <% end %>
    <% end %>
    <% if current_user.has_role?("publisher") || current_user.has_role?("editor") || current_user.admin? %>
    <p><input id="pac-input" class="controls" type="text"
        placeholder="Enter a location"> Geometry: <%= @place.latitude %>, <%= @place.longitude %></p>

    <div class="map-container">
      <div class="map-canvas"></div>
    </div>

    <div class="form-group lat-lng">
      <%= f.input :display_address, placeholder: 'Address', :input_html => { "data-geo" => "formatted_address", class: 'longer-input' }, label: "Display Address" %>
      <%= f.input :latitude, as: :hidden, :input_html => { "data-geo" => "lat" } %>
      <%= f.input :longitude, as: :hidden, :input_html => { "data-geo" => "lng" } %>
      <%= f.input :street_number, :input_html => { "data-geo" => "street_number" } %>
      <%= f.input :route, :input_html => { "data-geo" => "route", class: 'form-control' } %>
      <%= f.input :sublocality, :input_html => { "data-geo" => "sublocality", class: 'form-control' } %>
      <%= f.input :locality, :input_html => { "data-geo" => "locality", class: 'form-control' } %>
      <%= f.input :state, :input_html => { "data-geo" => "administrative_area_level_1", class: 'form-control' } %>
      <%= f.input :post_code, as: :string, :input_html => { "data-geo" => "postal_code" } %>
      <%= f.input :phone_number, input_html: { "data-geo" => "formatted_phone_number", class: 'form-control' } %>
      <%= f.input :place_id, input_html: { "data-geo" => "place_id", class: 'form-control' }, label: "Google Place ID" %>
    </div>
    <div class="form-group">
      <%= f.input :area_id, label: 'Change Area', collection: @areas, as: :select, label_method: :display_name, value_method: :id, required: true %>
    </div>
    <div class="field">
      <% Category.all.each do |category| %>
        <%= hidden_field_tag "place[category_ids][]", nil%>
        <%= check_box_tag "place[category_ids][]", category.id, @place.category_ids.include?(category.id), id: dom_id(category) %>
        <%= label_tag dom_id(category), category.name %><br/>
      <% end %>
    </div>
    <p>
      <div class="btn btn-info" id="approve-all">Check All Approved</div>
    </p>
    <div id="table-container">
      <h3>Videos</h3>
      <table class="table table-striped" id="video-table">
        <thead>
          <tr>
            <th>Preview</th>
            <th>Vimeo ID</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Include In Country</th>
            <th>In Customer Review</th>
            <th>Customer Approved</th>
            <th>Updated By</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody>
          <% @place.videos.each do |video| %>
            <%= f.fields_for :videos, video do |ff| %>
              <tr>
                <%= ff.input :id, as: :hidden %>
                <td></td>
                <td><%= ff.text_area :vimeo_id %></td>
                <td><%= ff.select :priority, 1..10 %></td>
                <td><%= ff.select :status, ["draft", "edited", "live", "removed"] %></td>
                <td><%= ff.check_box :country_include %></td>
                <td><%= ff.check_box :customer_review, class: 'customer-review' %></td>
                <td><%= ff.check_box :customer_approved, class: 'customer-approve' %><br><%= video.approved_at.strftime('%F at %T') if video.approved_at %></td>
                <td><%= !video.versions.blank? && video.versions.last.whodunnit ? User.find(video.versions.last.whodunnit).email : "" %><br><%= video.updated_at.strftime('%F at %T') %></td>
                <td><%= ff.check_box :_destroy %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    <div id="table-container">
      <h3>Photos</h3>
      <table class="table table-striped" id="photo-table">
        <thead>
          <tr>
            <th>Thumbnail</th>
            <th>Change Photo</th>
            <th>Credit</th>
            <th>Caption</th>
            <th>Alt Tags</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Include In Country</th>
            <th>In Customer Review</th>
            <th>Customer Approved</th>
            <th>Updated By</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% @place.photos.each do |photo| %>
            <%= f.fields_for :photos, photo do |ff| %>
              <tr>
                <%= ff.input :id, as: :hidden %>
                <td><img src="<%= asset_path(photo.path_url) %>" class="photo-edit-thumb"></td>
                <td><%= ff.file_field :path, class: "photo-file" %></td>
                <td><%= ff.text_area :credit %></td>
                <td class="photo-caption-edit"><%= ff.text_area :caption, :cols => "30", :rows => "5" %></td>
                <td><%= ff.text_field :alt_tag %></td>
                <td><%= ff.select :priority, 1..10 %></td>
                <td><%= ff.select :status, ["draft", "edited", "live", "removed"] %></td>
                <td><%= ff.check_box :country_include %></td>
                <td><%= ff.check_box :customer_review, class: 'customer-review' %></td>
                <td><%= ff.check_box :customer_approved, class: 'customer-approve' %><br><%= photo.approved_at.strftime('%F at %T') if photo.approved_at %></td>
                <td><%= !photo.versions.blank? && photo.versions.last.whodunnit ? User.find(photo.versions.last.whodunnit).email : "" %><br><%= photo.updated_at.strftime('%F at %T') %></td>
                <td><%= ff.check_box :_destroy %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    <div id="table-container">
      <h3>Games</h3>
      <table class="table table-striped" id="game-table">
        <thead>
          <tr>
            <th>Thumbnail</th>
            <th>URL</th>
            <th>Game Type</th>
            <th>Priority</th>
            <th>Status</th>
            <th>In Customer Review</th>
            <th>Customer Approved</th>
            <th>Updated By</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% @place.games.each do |game| %>
            <%= f.fields_for :games, game do |ff| %>
              <tr>
                <%= ff.input :id, as: :hidden %>
                <td><img src="<%= game_thumbnail(game) %>" class="photo-edit-thumb"></td>
                <td><%= ff.text_area :url, :cols => "50", :rows => "3" %></td>
                <td><%= ff.select :game_type, ["jigsaw puzzle", "word search", "slider"] %></td>
                <td><%= ff.select :priority, 1..10 %></td>
                <td><%= ff.select :status, ["draft", "edited", "live", "removed"] %></td>
                <td><%= ff.check_box :customer_review, class: 'customer-review' %></td>
                <td><%= ff.check_box :customer_approved, class: 'customer-approve' %><br><%= game.approved_at.strftime('%F at %T') if game.approved_at %></td>
                <td><%= !game.versions.blank? && game.versions.last.whodunnit ? User.find(game.versions.last.whodunnit).email : "" %><br><%= game.updated_at.strftime('%F at %T') %></td>
                <td><%= ff.check_box :_destroy %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    <div id="table-container">
      <h3>Fun Facts</h3>
      <table class="table table-striped" id="fun-fact-table">
        <thead>
          <tr>
            <th>Content</th>
            <th>Reference</th>
            <th>Hero Photo</th>
            <th>Photo Credit</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Include In Country</th>
            <th>In Customer Review</th>
            <th>Customer Approved</th>
            <th>Updated By</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% @place.fun_facts.each do |fun_fact| %>
            <%= f.fields_for :fun_facts, fun_fact do |ff| %>
              <tr>
                <%= ff.input :id, as: :hidden %>
                <td><%= ff.text_field :content %></td>
                <td><%= ff.text_field :reference %></td>
                <td><%= ff.file_field :hero_photo %></td>
                <td><%= ff.text_field :photo_credit %></td>
                <td><%= ff.select :priority, 1..10 %></td>
                <td><%= ff.select :status, ["draft", "edited", "live", "removed"] %></td>
                <td><%= ff.check_box :country_include %></td>
                <td><%= ff.check_box :customer_review, class: 'customer-review' %></td>
                <td><%= ff.check_box :customer_approved, class: 'customer-approve' %><br><%= fun_fact.approved_at.strftime('%F at %T') if fun_fact.approved_at %></td>
                <td><%= !fun_fact.versions.blank? && fun_fact.versions.last.whodunnit ? User.find(fun_fact.versions.last.whodunnit).email : "" %><br><%= fun_fact.updated_at.strftime('%F at %T') %></td>
                <td><%= ff.check_box :_destroy %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    <div id="table-container">
      <h3>Specials</h3>
      <table class="table table-striped" id="discount-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Include In Country</th>
            <th>In Customer Review</th>
            <th>Customer Approved</th>
            <th>Updated By</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% @place.discounts.each do |discount| %>
            <%= f.fields_for :discounts, discount do |ff| %>
              <tr>
                <%= ff.input :id, as: :hidden %>
                <td><%= ff.bootsy_area :description %></td>
                <td><%= ff.select :priority, 1..10 %></td>
                <td><%= ff.select :status, ["draft", "edited", "live", "removed"] %></td>
                <td><%= ff.check_box :country_include %></td>
                <td><%= ff.check_box :customer_review, class: 'customer-review' %></td>
                <td><%= ff.check_box :customer_approved, class: 'customer-approve' %><br><%= discount.approved_at.strftime('%F at %T') if discount.approved_at %></td>
                <td><%= !discount.versions.blank? && discount.versions.last.whodunnit ? User.find(discount.versions.last.whodunnit).email : "" %><br><%= discount.updated_at.strftime('%F at %T') %></td>
                <td><%= ff.check_box :_destroy %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="form-group">
      <%= f.button :submit, 'Update All' %>
    </div>
    <% end %>
  <% end %>
  <div class="edit_photo">
    <%= render "/videos/form" %>
  </div>

  <div class="edit_photo">
    <%= render "/photos/form" %>
  </div>

  <div class="edit_photo">
    <%= render "/discounts/form" %>
  </div>

  <div class="edit_photo">
    <%= render "/games/form" %>
  </div>

  <div class="edit_photo">
    <%= render "/fun_facts/form" %>
  </div>

  <div class="edit_photo">
    <%= render "/programs/form" %>
  </div>
<% else %>
  <h3>Sorry, you must be logged in to view this page</h3>
<% end %>
</div>


<script>
    $('.caption').on("keypress", function(){
        var len = $(this).val().length;
        $(this).closest('.control-group').next('.charCount').text(140 - len);
    });

    $('.customer-approve').on('click', function(){
      if ($(this)[0].checked == true){
        $(this).parent().siblings().find(".customer-review").attr("checked", false)
      }
    });

    $('#approve-all').on('click', function(){
      $('.customer-approve').attr("checked", true);
      $('.customer-review').attr("checked", false);
    });
</script>

<%= javascript_include_tag 'area.js' %>
